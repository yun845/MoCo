<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œå‹•æ•‘æ´é€šè¨Šå™¨-é›²ç«¯ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #eef2f3; }
        .sos-btn { 
            width: 100%; max-width: 280px; height: 120px; 
            font-size: 22px; font-weight: bold; color: white;
            background: #d35400; border: none; border-radius: 60px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); cursor: pointer;
            transition: 0.3s;
        }
        .sos-btn:active { transform: scale(0.95); background: #a04000; }
        #status { color: #7f8c8d; font-size: 14px; margin-bottom: 10px; }
        #log { margin-top: 20px; text-align: left; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .msg-item { border-left: 5px solid #d35400; padding: 10px; margin-bottom: 10px; background: #fff9f5; border-radius: 5px; }
        .map-link { display: inline-block; margin-top: 5px; color: #2980b9; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸš¨ è¡Œå‹•æ•‘æ´å»£æ’­ç³»çµ±</h2>
    <div id="status">é€šè¨Šé€£ç·šä¸­...</div>
    
    <button class="sos-btn" id="sendBtn">ç™¼é€æˆ‘çš„åº§æ¨™</button>

    <div id="log">
        <strong>æœ€æ–°æ•‘æ´è«‹æ±‚ï¼š</strong>
        <div id="messageList"></div>
    </div>

    <script>
        // --- é€šè¨Šè¨­å®š ---
        const TOPIC = "moco/project/sos/yourname"; // å»ºè­°æ”¹ç‚ºä½ çš„åå­—ï¼Œé¿å…è·Ÿåˆ¥äººé‡è¤‡
        const client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "client_" + Math.random());

        // ç•¶é€£ç·šæˆåŠŸæ™‚
        client.onConnected = () => {
            document.getElementById('status').innerText = "âœ… ç³»çµ±å·²é€£ç·š (é›²ç«¯é€šè¨Šä¸­)";
            client.subscribe(TOPIC); // è¨‚é–±é »é“ï¼Œæº–å‚™æ¥æ”¶è¨Šæ¯
        };

        // ç•¶æ”¶åˆ°è¨Šæ¯æ™‚
        client.onMessageArrived = (message) => {
            const data = JSON.parse(message.payloadString);
            const div = document.createElement('div');
            div.className = 'msg-item';
            const mapUrl = `https://www.google.com/maps?q=${data.lat},${data.lng}`;
            div.innerHTML = `
                <b>[æ±‚æ•‘è¨Šè™Ÿ]</b> <br>
                æ™‚é–“: ${new Date().toLocaleTimeString()} <br>
                åº§æ¨™: ${data.lat.toFixed(4)}, ${data.lng.toFixed(4)} <br>
                <a href="${mapUrl}" target="_blank" class="map-link">ğŸ“ é»æˆ‘é–‹å•Ÿ Google åœ°åœ–å°èˆª</a>
            `;
            document.getElementById('messageList').prepend(div);
        };

        client.connect({ onSuccess: () => { client.onConnected(); }, useSSL: true });

        // --- è¡Œå‹•åŠŸèƒ½ï¼šæŠ“å– GPS ---
        document.getElementById('sendBtn').onclick = () => {
            if (navigator.geolocation) {
                document.getElementById('sendBtn').innerText = "å®šä½ä¸­...";
                navigator.geolocation.getCurrentPosition((pos) => {
                    const payload = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    };
                    // é€å‡ºè¨Šæ¯
                    const message = new Paho.MQTT.Message(JSON.stringify(payload));
                    message.destinationName = TOPIC;
                    client.send(message);
                    
                    document.getElementById('sendBtn').innerText = "ç™¼é€æˆ‘çš„åº§æ¨™";
                    alert("æ•‘æ´è¨Šè™Ÿå·²å»£æ’­ï¼");
                }, (err) => {
                    alert("è«‹é–‹å•Ÿæ‰‹æ©Ÿ GPS æ¬Šé™");
                    document.getElementById('sendBtn').innerText = "ç™¼é€æˆ‘çš„åº§æ¨™";
                });
            }
        };
    </script>
</body>
</html>
