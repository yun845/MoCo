<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œå‹•ç‹€æ…‹ç›£æ§æ•‘æ´ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 15px; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .sos-btn { 
            width: 150px; height: 150px; border-radius: 50%; background: #d63031;
            color: white; border: none; font-size: 20px; font-weight: bold;
            box-shadow: 0 8px 20px rgba(214, 48, 49, 0.4); cursor: pointer; margin: 15px 0;
        }
        .permission-btn { background: #4CAF50; color: white; padding: 8px 12px; border: none; border-radius: 5px; margin: 5px; font-size: 12px; }
        #stateDisplay { text-align: left; background: #2d3436; color: #00ff00; padding: 15px; border-radius: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; overflow-x: auto; }
        .msg-item { border-left: 5px solid #0984e3; background: #f1f9ff; padding: 10px; margin-top: 10px; text-align: left; border-radius: 5px; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¡ è¡Œå‹•ç‹€æ…‹ç›£æ§æ•‘æ´</h2>
    
    <div id="status" style="font-size: 13px; color: #666;">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    <div style="margin-bottom: 15px;">
        <button class="permission-btn" onclick="requestSensorPermissionsManually()">æˆæ¬Šæ„Ÿæ¸¬å™¨ (iOS)</button>
        <button class="permission-btn" onclick="retryGeolocation()">é‡æ–°æˆæ¬Šå®šä½</button>
    </div>

    <button class="sos-btn" id="sendBtn">ç™¼é€ç•¶å‰<br>ç‹€æ…‹èˆ‡åº§æ¨™</button>

    <h3>ğŸ“Š å³æ™‚æ„Ÿæ¸¬å™¨æ•¸æ“šï¼š</h3>
    <pre id="stateDisplay">ç­‰å¾…æ„Ÿæ¸¬å™¨è³‡æ–™...</pre>

    <div id="log">
        <strong>ğŸš© æ•‘æ´çœ‹æ¿ï¼š</strong>
        <div id="messageList"></div>
    </div>
</div>

<script>
    // ----------------------------
    // 1. MQTT èˆ‡ å…¨åŸŸè®Šæ•¸
    // ----------------------------
    const SHARED_TOPIC = "moco/final/sensor_rescue_system";
    const client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "user_" + Math.random().toString(16).substr(2, 5));

    const deviceState = {
        lat: null, lon: null,
        accel: { x: 0, y: 0, z: 0 },
        orientation: { alpha: 0, beta: 0, gamma: 0 }
    };

    // ----------------------------
    // 2. é€šè¨Šé‚è¼¯
    // ----------------------------
    client.onConnected = () => {
        document.getElementById('status').innerText = "âœ… é›²ç«¯å·²é€£ç·š";
        client.subscribe(SHARED_TOPIC);
    };

    client.onMessageArrived = (message) => {
        const data = JSON.parse(message.payloadString);
        const list = document.getElementById('messageList');
        const div = document.createElement('div');
        div.className = "msg-item";
        const mapUrl = `https://www.google.com/maps?q=${data.lat},${data.lon}`;
        
        div.innerHTML = `
            <b>ğŸš¨ æ”¶åˆ°ç‹€æ…‹æ›´æ–°</b> (${new Date().toLocaleTimeString()})<br>
            ğŸ“ åº§æ¨™: ${data.lat?.toFixed(4)}, ${data.lon?.toFixed(4)}<br>
            ğŸ“ å‚¾æ–œåº¦: Beta:${data.orientation.beta?.toFixed(1)}Â°, Gamma:${data.orientation.gamma?.toFixed(1)}Â°<br>
            éœ‡å‹•(G): X:${data.accel.x?.toFixed(1)}, Y:${data.accel.y?.toFixed(1)}<br>
            <a href="${mapUrl}" target="_blank" style="color:#0984e3; font-weight:bold;">åœ¨åœ°åœ–æŸ¥çœ‹ä½ç½®</a>
        `;
        list.prepend(div);
    };

    client.connect({ onSuccess: () => client.onConnected(), useSSL: true });

    // ----------------------------
    // 3. æ„Ÿæ¸¬å™¨é‚è¼¯ (å¾ä½ æä¾›çš„ç¨‹å¼ç¢¼æ•´åˆ)
    // ----------------------------
    function onStateUpdate() {
        document.getElementById("stateDisplay").textContent = JSON.stringify(deviceState, null, 2);
    }

    // Geolocation
    function startGeolocationWatch() {
        navigator.geolocation.watchPosition((pos) => {
            deviceState.lat = pos.coords.latitude;
            deviceState.lon = pos.coords.longitude;
            onStateUpdate();
        }, (err) => console.error(err), { enableHighAccuracy: true });
    }

    // Motion & Orientation
    function startSensors() {
        // åŠ é€Ÿåº¦è¨ˆ
        window.addEventListener("devicemotion", (event) => {
            const acc = event.accelerationIncludingGravity || {};
            deviceState.accel.x = acc.x || 0;
            deviceState.accel.y = acc.y || 0;
            deviceState.accel.z = acc.z || 0;
            onStateUpdate();
        });
        // é™€èºå„€
        window.addEventListener("deviceorientation", (event) => {
            deviceState.orientation.alpha = event.alpha || 0;
            deviceState.orientation.beta = event.beta || 0;
            deviceState.orientation.gamma = event.gamma || 0;
            onStateUpdate();
        });
    }

    // iOS æ‰‹å‹•æˆæ¬ŠæŒ‰éˆ•é‚è¼¯
    async function requestSensorPermissionsManually() {
        if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
            const state = await DeviceMotionEvent.requestPermission();
            if (state === "granted") startSensors();
        }
        if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
            const state = await DeviceOrientationEvent.requestPermission();
            if (state === "granted") startSensors();
        }
    }

    function retryGeolocation() {
        startGeolocationWatch();
    }

    // ----------------------------
    // 4. ç™¼é€æŒ‰éˆ•é‚è¼¯
    // ----------------------------
    document.getElementById('sendBtn').onclick = () => {
        if (deviceState.lat === null) {
            alert("å°šæœªå–å¾— GPS åº§æ¨™ï¼Œè«‹ç¨å€™...");
            return;
        }
        const message = new Paho.MQTT.Message(JSON.stringify(deviceState));
        message.destinationName = SHARED_TOPIC;
        client.send(message);
        alert("ç•¶å‰ç‹€æ…‹å·²æˆåŠŸå»£æ’­ï¼");
    };

    // åˆå§‹åŒ–
    window.onload = () => {
        startGeolocationWatch();
        startSensors();
    };
</script>
</body>
</html>
