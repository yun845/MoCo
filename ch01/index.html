<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œå‹•æ•‘æ´å…±äº«ç³»çµ±-å¤šäººé€£ç·šç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; text-align: center; background: #eef2f7; padding: 20px; color: #333; }
        .container { max-width: 450px; margin: 0 auto; }
        
        /* æ•‘æ´æŒ‰éˆ•ï¼šåŠ å¤§ä¸”æœ‰å‘¼å¸ç‡ˆæ•ˆæœ */
        .sos-btn { 
            width: 200px; height: 200px; border-radius: 50%; background: #d63031;
            color: white; border: none; font-size: 24px; font-weight: bold;
            box-shadow: 0 10px 25px rgba(214, 48, 49, 0.4); cursor: pointer;
            transition: 0.3s; margin: 20px 0;
        }
        .sos-btn:active { transform: scale(0.92); }
        
        #debug-info { color: #d35400; font-weight: bold; font-size: 14px; min-height: 24px; margin-bottom: 10px; }
        
        /* è¨Šæ¯çœ‹æ¿ */
        #log { text-align: left; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .msg-item { border-left: 6px solid #0984e3; padding: 12px; margin-bottom: 15px; background: #f1f9ff; border-radius: 8px; animation: fadeIn 0.5s; }
        .my-post { border-left-color: #00b894; background: #f0fff4; }
        
        .map-link { 
            display: inline-block; margin-top: 10px; background: #0984e3; color: white;
            padding: 8px 15px; border-radius: 5px; text-decoration: none; font-size: 14px; font-weight: bold;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¡ é›²ç«¯å³æ™‚æ•‘æ´é »é“</h2>
    <div id="status">â³ æ­£åœ¨åŠ å…¥æ•‘æ´ç¶²è·¯...</div>
    
    <center>
        <button class="sos-btn" id="sendBtn">ç™¼é€åº§æ¨™<br>æ±‚æ•‘</button>
    </center>

    <div id="debug-info"></div>

    <div id="log">
        <strong>ğŸš© å³æ™‚æ•‘æ´çœ‹æ¿ (å…¨é »é“)ï¼š</strong>
        <hr>
        <div id="messageList">
            <p style="color:#999; text-align:center;">ç›®å‰å°šç„¡æ•‘æ´è«‹æ±‚...</p>
        </div>
    </div>
</div>

<script>
    // --- 1. MQTT å¤šäººé€šè¨Šè¨­å®š ---
    // æˆ‘å€‘ä½¿ç”¨åŒä¸€å€‹ TOPICï¼Œé€™æ¨£æ‰€æœ‰é»é–‹ç¶²é çš„äººéƒ½èƒ½äº’ç›¸çœ‹åˆ°è¨Šæ¯
    const SHARED_TOPIC = "moco/final/shared_rescue_board"; 
    const client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "user_" + Math.random().toString(16).substr(2, 5));

    client.onConnected = () => {
        document.getElementById('status').innerText = "âœ… å·²é€²å…¥å…±äº«é »é“ï¼šå¤šäººé€£ç·šä¸­";
        client.subscribe(SHARED_TOPIC);
    };

    // ç•¶é›²ç«¯å‚³ä¾†ã€Œä»»ä½•äººã€çš„åº§æ¨™æ™‚
    client.onMessageArrived = (message) => {
        try {
            const data = JSON.parse(message.payloadString);
            // ç§»é™¤ã€Œå°šç„¡è¨Šæ¯ã€çš„æç¤º
            if (document.querySelector('#messageList p')) document.querySelector('#messageList p').remove();
            
            addToList(data.lat, data.lng, data.senderId);
        } catch(e) { console.log("æ”¶åˆ°ç„¡æ•ˆè¨Šæ¯"); }
    };

    // æ–·ç·šé‡é€£æ©Ÿåˆ¶
    client.onConnectionLost = (responseObject) => {
        document.getElementById('status').innerText = "âŒ é€£ç·šä¸­æ–·ï¼Œæ­£åœ¨é‡é€£...";
        setTimeout(() => client.connect({ onSuccess: client.onConnected, useSSL: true }), 3000);
    };

    client.connect({ onSuccess: client.onConnected, useSSL: true });

    // --- 2. é¡¯ç¤ºæ¸…å–®åŠŸèƒ½ ---
    function addToList(lat, lng, senderId) {
        const list = document.getElementById('messageList');
        const div = document.createElement('div');
        
        // åˆ¤æ–·æ˜¯ä¸æ˜¯è‡ªå·±ç™¼çš„ (é€ééš¨æ©Ÿ ID)
        const isMe = client.clientId === senderId;
        div.className = isMe ? "msg-item my-post" : "msg-item";
        
        const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
        
        div.innerHTML = `
            <b>${isMe ? "ğŸ“ æˆ‘çš„ç™¼é€ç´€éŒ„" : "ğŸš¨ æ”¶åˆ°æ±‚æ•‘è¨Šè™Ÿ"}</b><br>
            <small>æ™‚é–“ï¼š${new Date().toLocaleTimeString()}</small><br>
            åº§æ¨™ï¼š${lat.toFixed(5)}, ${lng.toFixed(5)}<br>
            <a href="${mapUrl}" target="_blank" class="map-link">åœ¨åœ°åœ–æŸ¥çœ‹ä¸¦å°èˆª</a>
        `;
        list.prepend(div);
    }

    // --- 3. å®šä½èˆ‡å»£æ’­åŠŸèƒ½ ---
    const sendBtn = document.getElementById('sendBtn');
    const debug = document.getElementById('debug-info');

    sendBtn.onclick = () => {
        if (!navigator.geolocation) return alert("æ‚¨çš„æ‰‹æ©Ÿä¸æ”¯æ´å®šä½");

        sendBtn.innerText = "æ­£åœ¨å®šä½...";
        debug.innerText = "ğŸ“¡ æœå°‹ GPS è¡›æ˜Ÿä¸­ (è«‹è‡³çª—é‚Š)...";

        const options = { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 };

        const success = (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            
            debug.innerText = "âœ… åº§æ¨™ç²å–æˆåŠŸï¼Œæ­£åœ¨å»£æ’­...";

            // å°‡åº§æ¨™ç™¼é€çµ¦æ‰€æœ‰åœ¨é »é“ä¸Šçš„äºº
            const payload = {
                lat: lat,
                lng: lng,
                senderId: client.clientId // æ¨™è¨˜æ˜¯èª°ç™¼çš„
            };
            
            const message = new Paho.MQTT.Message(JSON.stringify(payload));
            message.destinationName = SHARED_TOPIC;
            client.send(message);

            sendBtn.innerText = "ç™¼é€åº§æ¨™\næ±‚æ•‘";
            debug.innerText = "ğŸš€ è¨Šæ¯å·²åŒæ­¥è‡³æ‰€æœ‰è¨­å‚™ï¼";
        };

        const error = (err) => {
            // å¦‚æœ GPS å¤ªæ…¢ï¼Œè‡ªå‹•é™ç´šåˆ°ç¶²è·¯å®šä½
            if (err.code === 3) {
                debug.innerText = "âš ï¸ GPS è¨Šè™Ÿå¼±ï¼Œåˆ‡æ›åŸºåœ°å°æ¨¡å¼...";
                navigator.geolocation.getCurrentPosition(success, (e) => {
                    alert("å®šä½å¤±æ•—ï¼šè«‹ç¢ºèªæ‰‹æ©Ÿ GPS å·²é–‹å•Ÿä¸”éå®¤å…§æ·±è™•ã€‚");
                    sendBtn.innerText = "ç™¼é€åº§æ¨™\næ±‚æ•‘";
                    debug.innerText = "";
                }, { enableHighAccuracy: false, timeout: 5000 });
            } else {
                alert("éŒ¯èª¤ï¼š" + err.message);
                sendBtn.innerText = "ç™¼é€åº§æ¨™\næ±‚æ•‘";
            }
        };

        navigator.geolocation.getCurrentPosition(success, error, options);
    };
</script>
</body>
</html>
