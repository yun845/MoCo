<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œå‹•æ•‘æ´é€šè¨Šç³»çµ±</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        /* CSS æ¨£å¼ï¼šç¾åŒ–ä»‹é¢ä½¿å…¶æ›´åƒä¸€å€‹æ‰‹æ©Ÿ App */
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background: #f0f2f5; color: #333; }
        
        .container { max-width: 400px; margin: 0 auto; }
        
        /* æ•‘æ´æŒ‰éˆ•æ¨£å¼ */
        .sos-btn { 
            width: 220px; height: 220px; border-radius: 50%;
            background: linear-gradient(145deg, #ff5252, #d32f2f);
            color: white; border: none; font-size: 26px; font-weight: bold;
            box-shadow: 0 10px 20px rgba(211, 47, 47, 0.4);
            cursor: pointer; margin: 20px 0; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; line-height: 1.4;
        }
        .sos-btn:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.2); }

        /* ç‹€æ…‹æ–‡å­— */
        #status { font-size: 14px; color: #666; margin-bottom: 20px; padding: 5px; border-radius: 5px; }
        
        /* è¨Šæ¯æ¸…å–®æ¨£å¼ */
        #log { text-align: left; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .msg-item { border-left: 5px solid #ff5252; padding: 12px; margin-bottom: 12px; background: #fff5f5; border-radius: 8px; font-size: 14px; }
        .map-link { display: inline-block; margin-top: 8px; color: #1a73e8; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸš¨ ç·Šæ€¥æ•‘æ´ç³»çµ±</h2>
        <div id="status">æ­£åœ¨é€£ç·šè‡³é›²ç«¯é€šè¨Šä¸­å¿ƒ...</div>
        
        <center>
            <button class="sos-btn" id="sendBtn">ç™¼é€åº§æ¨™<br>è«‹æ±‚æ•‘æ´</button>
        </center>

        <div id="log">
            <strong>æœ€æ–°æ•‘æ´è«‹æ±‚æ¸…å–®ï¼š</strong>
            <hr>
            <div id="messageList"></div>
        </div>
    </div>

    <script>
        // --- 1. é€šè¨Šæ¨¡çµ„è¨­å®š (MQTT) ---
        // ä½¿ç”¨å…¬å…±æ¸¬è©¦ Brokerï¼ŒTOPIC åŠ å…¥éš¨æ©Ÿç¢¼é¿å…è·Ÿå…¶ä»–åŒå­¸è¡çª
        const TOPIC = "moco/sos/project/user_" + Math.floor(Math.random() * 1000); 
        const client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "client_" + Math.random());

        // é€£ç·šæˆåŠŸæ™‚çš„å›å‘¼å‡½æ•¸
        client.onConnected = () => {
            document.getElementById('status').innerText = "âœ… ç³»çµ±å·²é€£ç·š (é »é“: " + TOPIC + ")";
            client.subscribe(TOPIC); 
        };

        // æ”¶åˆ°æ±‚æ•‘è¨Šæ¯æ™‚çš„å›å‘¼å‡½æ•¸
        client.onMessageArrived = (message) => {
            const data = JSON.parse(message.payloadString);
            const div = document.createElement('div');
            div.className = 'msg-item';
            // å»ºç«‹ Google åœ°åœ–é€£çµ
            const mapUrl = `https://www.google.com/maps?q=${data.lat},${data.lng}`;
            div.innerHTML = `
                <b>[æ”¶åˆ°æ±‚æ•‘è¨Šè™Ÿ]</b><br>
                æ™‚é–“: ${new Date().toLocaleTimeString()}<br>
                åº§æ¨™: ${data.lat.toFixed(5)}, ${data.lng.toFixed(5)}<br>
                <a href="${mapUrl}" target="_blank" class="map-link">ğŸ“ é–‹å•Ÿ Google åœ°åœ–å°èˆª</a>
            `;
            document.getElementById('messageList').prepend(div);
        };

        // åŸ·è¡Œé€£ç·š
        client.connect({ onSuccess: () => { client.onConnected(); }, useSSL: true });


        // --- 2. è¡Œå‹•å®šä½æ¨¡çµ„ (Geolocation) ---
        const sendBtn = document.getElementById('sendBtn');

        sendBtn.onclick = () => {
            if (navigator.geolocation) {
                sendBtn.innerText = "å®šä½ä¸­...";
                sendBtn.style.opacity = "0.7";

                // å®šä½è¨­å®šï¼šå¹³è¡¡é€Ÿåº¦èˆ‡ç²¾ç¢ºåº¦
                const options = {
                    enableHighAccuracy: true, // å„ªå…ˆä½¿ç”¨ GPS
                    timeout: 7000,            // æœ€å¤šç­‰ 7 ç§’ï¼Œé¿å…å¡æ­»
                    maximumAge: 0             // å¼·åˆ¶æŠ“å–æœ€æ–°ä½ç½®
                };

                const startPositioning = (opt) => {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            // å®šä½æˆåŠŸå¾Œçš„è™•ç†é‚è¼¯
                            const payload = {
                                lat: pos.coords.latitude,
                                lng: pos.coords.longitude
                            };
                            
                            // é€éé€šè¨Šæ¨¡çµ„ç™¼é€ JSON æ•¸æ“š
                            const message = new Paho.MQTT.Message(JSON.stringify(payload));
                            message.destinationName = TOPIC;
                            client.send(message);

                            sendBtn.innerText = "ç™¼é€åº§æ¨™\nè«‹æ±‚æ•‘æ´";
                            sendBtn.style.opacity = "1";
                            alert("âœ… åº§æ¨™ç™¼é€æˆåŠŸï¼");
                        },
                        (err) => {
                            // å¦‚æœç²¾ç¢ºå®šä½è¶…æ™‚ï¼Œè‡ªå‹•åˆ‡æ›åˆ°å¿«é€Ÿå®šä½æ¨¡å¼
                            if (err.code === err.TIMEOUT) {
                                console.log("åˆ‡æ›è‡³å¿«é€Ÿå®šä½...");
                                navigator.geolocation.getCurrentPosition(
                                    (pos) => { /* å¿«é€Ÿå®šä½æˆåŠŸé‚è¼¯åŒä¸Š */
                                        const payload = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                                        const message = new Paho.MQTT.Message(JSON.stringify(payload));
                                        message.destinationName = TOPIC;
                                        client.send(message);
                                        sendBtn.innerText = "ç™¼é€åº§æ¨™\nè«‹æ±‚æ•‘æ´";
                                        sendBtn.style.opacity = "1";
                                        alert("âœ… å®šä½æˆåŠŸ(ä½¿ç”¨ç¶²è·¯è¼”åŠ©)ï¼");
                                    },
                                    (e) => { alert("ç„¡æ³•ç²å–ä½ç½®ï¼Œè«‹åˆ°ç©ºæ› è™•é‡è©¦"); },
                                    { enableHighAccuracy: false, timeout: 5000 }
                                );
                            } else {
                                alert("éŒ¯èª¤: " + err.message);
                                sendBtn.innerText = "ç™¼é€åº§æ¨™\nè«‹æ±‚æ•‘æ´";
                            }
                        },
                        opt
                    );
                };

                startPositioning(options);
            } else {
                alert("æ­¤è£ç½®ä¸æ”¯æ´ GPS å®šä½");
            }
        };
    </script>
</body>
</html>
