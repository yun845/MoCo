<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>æœŸæœ«å°ˆæ¡ˆï¼šéŠ€é«®å®ˆè­·è€… (è·Œå€’å‘Šè­¦ç³»çµ±)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; font-size: 24px; text-align: center; }
        .status-box { background: #e7f3ff; border: 1px solid #b3d7ff; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-sensor { background-color: #4CAF50; color: white; }
        .btn-geo { background-color: #2196F3; color: white; }
        #stateDisplay { background: #333; color: #fff; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 13px; }
        .alert-active { background-color: #ff4d4d !important; color: white; animation: blink 1s infinite; padding: 20px; border-radius: 10px; display: none; margin-top: 20px; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘µ éŠ€é«®å®ˆè­·è€…</h1>
    <div class="status-box" id="status">è«‹å…ˆé»æ“Šä¸‹æ–¹æŒ‰éˆ•æˆæ¬Šæ„Ÿæ¸¬å™¨</div>

    <div class="btn-group">
        <button class="btn-sensor" onclick="requestSensorPermissionsManually()">å•Ÿå‹•è·Œå€’åµæ¸¬ (iOS/Android)</button>
        <button class="btn-geo" onclick="retryGeolocation()">é‡æ–°è®€å– GPS å®šä½</button>
    </div>

    <div id="fallAlert" class="alert-active">
        <strong>ğŸš¨ åµæ¸¬åˆ°ç–‘ä¼¼è·Œå€’ï¼</strong><br>
        ç·Šæ€¥é€šè¨Šè¨Šæ¯å·²ç™¼é€è‡³é›²ç«¯ã€‚<br>
        <span id="locationLink"></span>
        <br><br>
        <button onclick="resetAlert()" style="background: white; color: red;">æˆ‘æ²’äº‹ï¼Œå–æ¶ˆå‘Šè­¦</button>
    </div>

    <h3>è£ç½®å³æ™‚æ•¸æ“š (è¡Œå‹•è¦ç´ )ï¼š</h3>
    <pre id="stateDisplay">ç­‰å¾…è³‡æ–™ä¸­...</pre>
</div>

<script>
// --- 1. å…¨åŸŸç‹€æ…‹è®Šæ•¸ ---
const deviceState = {
    lat: null,
    lon: null,
    accel: { x: 0, y: 0, z: 0 }
};
let isAlerted = false; // æ¨™è¨˜æ˜¯å¦å·²è§¸ç™¼å‘Šè­¦

// --- 2. æ ¸å¿ƒé‚è¼¯ï¼šè·Œå€’åµæ¸¬ (å‰µæ–°é») ---
function detectFall(accel) {
    if (isAlerted) return;

    // è¨ˆç®—ç¸½åŠ é€Ÿåº¦ (åˆåŠ›)
    // ç•¶æ‰‹æ©Ÿæ’æ“Šåœ°é¢æ™‚ï¼Œç¸½åŠ é€Ÿåº¦æœƒç¬é–“æš´å¢
    const totalAccel = Math.sqrt(accel.x**2 + accel.y**2 + accel.z**2);
    
    // é–€æª»å€¼è¨­å®šï¼š25 m/sÂ² ä»¥ä¸Šè¦–ç‚ºç•°å¸¸è¡æ“Š (åœ°çƒé‡åŠ›ç´„ 9.8)
    if (totalAccel > 25) {
        isAlerted = true;
        sendEmergencySignal(totalAccel);
    }
}

// --- 3. é€šè¨Šå¯¦ä½œï¼šç™¼é€å‘Šè­¦ (é€šè¨Šé») ---
function sendEmergencySignal(impact) {
    const statusDiv = document.getElementById("status");
    const alertDiv = document.getElementById("fallAlert");
    const linkSpan = document.getElementById("locationLink");

    statusDiv.textContent = "ç‹€æ…‹ï¼šç·Šæ€¥ç‹€æ³ï¼";
    alertDiv.style.display = "block";

    // ç”¢ç”Ÿ Google åœ°åœ–é€šè¨Šé€£çµ
    const mapUrl = `https://www.google.com/maps?q=${deviceState.lat},${deviceState.lon}`;
    linkSpan.innerHTML = `<a href="${mapUrl}" target="_blank" style="color:white; text-decoration:underline;">é»æ­¤æŸ¥çœ‹é•·è¼©è·Œå€’ä½ç½®</a>`;

    // æ¨¡æ“¬é€šè¨Šï¼šåœ¨æ§åˆ¶å°è¼¸å‡ºé€šè¨Šå°åŒ…
    console.log("ã€é€šè¨Šç™¼é€ã€‘ç›®çš„åœ°ï¼šç·Šæ€¥æ•‘æ´ä¸­å¿ƒ");
    console.log(`ã€é€šè¨Šå…§å®¹ã€‘ç·¯åº¦:${deviceState.lat}, ç¶“åº¦:${deviceState.lon}, è¡æ“ŠåŠ›:${impact.toFixed(2)}`);
    
    // ç€è¦½å™¨è·³å‡ºå‘Šè­¦ (é€™ä¹Ÿæ˜¯ä¸€ç¨®ç°¡å–®çš„é€šè¨Šå›å ±)
    alert("ç·Šæ€¥é€šçŸ¥ï¼šåµæ¸¬åˆ°è·Œå€’ï¼ä½ç½®è³‡è¨Šå·²æº–å‚™å°±ç·’ã€‚");
}

function resetAlert() {
    isAlerted = false;
    document.getElementById("fallAlert").style.display = "none";
    document.getElementById("status").textContent = "ç‹€æ…‹ï¼šç›£æ§ä¸­";
}

// --- 4. åŸºç¤æ„Ÿæ¸¬å™¨èˆ‡å®šä½åŠŸèƒ½ (åƒè€ƒè€å¸«æ¶æ§‹) ---
function updateUI() {
    document.getElementById("stateDisplay").textContent = JSON.stringify(deviceState, null, 2);
}

// åœ°ç†ä½ç½® (Geolocation API)
function setupGeolocation() {
    if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(
            (position) => {
                deviceState.lat = position.coords.latitude;
                deviceState.lon = position.coords.longitude;
                updateUI();
            },
            (error) => console.error("å®šä½éŒ¯èª¤:", error),
            { enableHighAccuracy: true }
        );
    }
}

// é‹å‹•æ„Ÿæ¸¬å™¨ (Motion API)
function startMotionListener() {
    window.addEventListener("devicemotion", (event) => {
        const acc = event.accelerationIncludingGravity || { x: 0, y: 0, z: 0 };
        deviceState.accel.x = acc.x || 0;
        deviceState.accel.y = acc.y || 0;
        deviceState.accel.z = acc.z || 0;
        
        updateUI();
        detectFall(deviceState.accel); // æ¯æ¬¡æ›´æ–°æ•¸æ“šéƒ½æª¢æŸ¥æ˜¯å¦è·Œå€’
    });
}

// é‡å° iOS/ç¾ä»£ç€è¦½å™¨çš„æ¬Šé™è«‹æ±‚
async function requestSensorPermissionsManually() {
    if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
        try {
            const state = await DeviceMotionEvent.requestPermission();
            if (state === "granted") {
                startMotionListener();
                document.getElementById("status").textContent = "ç‹€æ…‹ï¼šç›£æ§ä¸­";
            }
        } catch (e) {
            alert("è«‹ç¢ºä¿ä½¿ç”¨ HTTPS ç’°å¢ƒé–‹å•Ÿç¶²é ä»¥ç²å¾—æ¬Šé™");
        }
    } else {
        startMotionListener();
        document.getElementById("status").textContent = "ç‹€æ…‹ï¼šç›£æ§ä¸­";
    }
}

function retryGeolocation() {
    setupGeolocation();
}

// ç¶²é é–‹å•Ÿè‡ªå‹•åŸ·è¡Œ
window.onload = () => {
    setupGeolocation();
};
</script>

</body>
</html>
