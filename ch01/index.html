<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œå‹•æ•‘æ´ç³»çµ±-ç©©å®šç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f4f4f4; padding: 20px; }
        .sos-btn { 
            width: 200px; height: 200px; border-radius: 50%; background: #e74c3c;
            color: white; border: none; font-size: 24px; font-weight: bold;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2); cursor: pointer;
        }
        #debug-info { color: #e67e22; font-size: 13px; margin: 10px; font-weight: bold; }
        #log { text-align: left; background: white; padding: 15px; border-radius: 10px; margin-top: 20px; }
        .msg-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
<body>

    <h2>ğŸš¨ è¡Œå‹•æ•‘æ´å»£æ’­ç³»çµ±</h2>
    <div id="status">MQTT é€£ç·šä¸­...</div>
    <div id="debug-info">æº–å‚™å°±ç·’</div>
    
    <button class="sos-btn" id="sendBtn">ç™¼é€åº§æ¨™</button>

    <div id="log">
        <strong>æ•‘æ´è¨Šæ¯æ¸…å–®ï¼š</strong>
        <div id="messageList"></div>
    </div>

    <script>
        // --- 1. é€šè¨Šè¨­å®š ---
        const TOPIC = "moco/sos/final/test12345"; // é »é“åç¨±
        const client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "cl_" + Math.random());

        client.onConnected = () => {
            document.getElementById('status').innerText = "âœ… ä¼ºæœå™¨å·²é€£ç·š";
            client.subscribe(TOPIC);
        };

        client.onMessageArrived = (message) => {
            const data = JSON.parse(message.payloadString);
            const div = document.createElement('div');
            div.className = 'msg-item';
            const mapUrl = `https://www.google.com/maps?q=${data.lat},${data.lng}`;
            div.innerHTML = `<b>[æ±‚æ•‘]</b> ${new Date().toLocaleTimeString()}<br>åº§æ¨™: ${data.lat.toFixed(4)},${data.lng.toFixed(4)} <br><a href="${mapUrl}" target="_blank">ğŸ“åœ¨åœ°åœ–æŸ¥çœ‹</a>`;
            document.getElementById('messageList').prepend(div);
        };

        client.connect({ onSuccess: () => { client.onConnected(); }, useSSL: true });

        // --- 2. å®šä½åŠŸèƒ½ (æ ¸å¿ƒä¿®æ”¹) ---
        const sendBtn = document.getElementById('sendBtn');
        const debug = document.getElementById('debug-info');

        sendBtn.onclick = () => {
            debug.innerText = "ğŸ” æ­£åœ¨å•Ÿå‹• GPS...";
            sendBtn.innerText = "å®šä½ä¸­...";
            
            // å®šä½æˆåŠŸè¦åšçš„äº‹
            const onUpdate = (pos) => {
                debug.innerText = "âœ… å®šä½æˆåŠŸï¼æ­£åœ¨å‚³é€...";
                const payload = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                const message = new Paho.MQTT.Message(JSON.stringify(payload));
                message.destinationName = TOPIC;
                client.send(message);
                sendBtn.innerText = "ç™¼é€åº§æ¨™";
                alert("å‚³é€æˆåŠŸï¼");
            };

            // å®šä½å¤±æ•—è¦åšçš„äº‹
            const onError = (err) => {
                if (err.code === 1) {
                    debug.innerText = "âŒ éŒ¯èª¤ï¼šä½ æ‹’çµ•äº†å®šä½æ¬Šé™";
                    alert("è«‹åœ¨æ‰‹æ©Ÿè¨­å®šä¸­å…è¨±ç€è¦½å™¨å­˜å–ä½ç½®");
                } else if (err.code === 3) {
                    debug.innerText = "âš ï¸ GPS è¶…æ™‚ï¼Œåˆ‡æ›è‡³åŸºåœ°å°å®šä½...";
                    // è¶…æ™‚å¾Œï¼Œè‡ªå‹•å˜—è©¦ã€Œä½ç²¾ç¢ºåº¦æ¨¡å¼ã€
                    navigator.geolocation.getCurrentPosition(onUpdate, (e) => {
                        debug.innerText = "âŒ å¾¹åº•å¤±æ•—ï¼šæŠ“ä¸åˆ°ä½ç½®";
                        alert("è«‹åˆ°çª—é‚Šæˆ–æˆ¶å¤–å†è©¦ä¸€æ¬¡");
                        sendBtn.innerText = "ç™¼é€åº§æ¨™";
                    }, { enableHighAccuracy: false, timeout: 5000 });
                } else {
                    debug.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message;
                }
            };

            // ç¬¬ä¸€æ¬¡å˜—è©¦ï¼šé«˜ç²¾ç¢ºåº¦ (GPS)
            navigator.geolocation.getCurrentPosition(onUpdate, onError, {
                enableHighAccuracy: true,
                timeout: 5000, // åªç­‰ 5 ç§’ï¼Œä¸ç­‰äº†
                maximumAge: 0
            });
        };
    </script>
</body>
</html>
