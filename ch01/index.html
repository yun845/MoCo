<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>éŠ€é«®å®ˆè­·è€… - å…·å‚™é€šè¨Šç´€éŒ„åŠŸèƒ½</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f0f2f5; transition: 0.5s; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .status-box { background: #e7f3ff; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-weight: bold; color: #0d6efd; }
        .alert-zone { background: #ff4d4d; color: white; padding: 20px; border-radius: 10px; display: none; margin-bottom: 20px; text-align: center; }
        #historySection { margin-top: 30px; border-top: 2px solid #ddd; padding-top: 10px; }
        .history-item { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .map-btn { background: #0d6efd; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
        pre { background: #333; color: #fff; padding: 10px; border-radius: 5px; font-size: 12px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 5px; background: #4CAF50; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘µ éŠ€é«®å®ˆè­·è€…</h1>
    <div id="status" class="status-box">ç­‰å¾…æˆæ¬Šä¸­...</div>

    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="initSensors()">å•Ÿå‹•ç›£æ§ç³»çµ±</button>
        <button style="background:#6c757d;" onclick="clearHistory()">æ¸…ç©ºç´€éŒ„</button>
    </div>

    <div id="fallAlert" class="alert-zone">
        <h2>ğŸš¨ åµæ¸¬åˆ°è·Œå€’ï¼</h2>
        <p>ä½ç½®èˆ‡æ™‚é–“å·²å­˜å…¥ç³»çµ±é€šè¨Šç´€éŒ„</p>
        <button onclick="resetAlert()" style="background: white; color: red;">æˆ‘æ²’äº‹ (é‡ç½®)</button>
    </div>

    <h3>å³æ™‚æ•¸å€¼ï¼š</h3>
    <pre id="stateDisplay">å°šæœªå–å¾—æ•¸æ“š</pre>

    <div id="historySection">
        <h3>ğŸ“ æ­·å²å®šä½ç´€éŒ„ (é€šè¨Šå„²å­˜å…§å®¹)</h3>
        <div id="historyList">å°šç„¡ç´€éŒ„</div>
    </div>
</div>

<script>
// --- 1. è³‡æ–™èˆ‡ç‹€æ…‹ ---
let deviceState = { lat: 0, lon: 0, x: 0, y: 0, z: 0 };
let isAlerted = false;
const THRESHOLD = 20; // æ¸¬è©¦æ™‚å¯èª¿ä½è‡³ 15

// --- 2. æ ¸å¿ƒï¼šè·Œå€’åµæ¸¬èˆ‡å„²å­˜ ---
function detectFall(accel) {
    if (isAlerted) return;
    const totalG = Math.sqrt(accel.x**2 + accel.y**2 + accel.z**2);

    if (totalG > THRESHOLD) {
        isAlerted = true;
        handleEmergency(totalG);
    }
}

function handleEmergency(impact) {
    // è®Šæ›´ä»‹é¢
    document.getElementById("fallAlert").style.display = "block";
    document.body.style.backgroundColor = "#ffebee";

    // å–å¾—æ™‚é–“èˆ‡åº§æ¨™
    const now = new Date();
    const timeStr = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
    const mapUrl = `https://www.google.com/maps?q=${deviceState.lat},${deviceState.lon}`;

    // --- å„²å­˜å…§å®¹ (é€šè¨Šæ¨¡æ“¬) ---
    const record = {
        time: timeStr,
        lat: deviceState.lat.toFixed(5),
        lon: deviceState.lon.toFixed(5),
        url: mapUrl
    };

    saveToStorage(record);
    renderHistory();
    alert("é€šè¨Šè­¦å‘Šï¼šè·Œå€’ä½ç½®å·²å­˜å…¥è³‡æ–™åº«ï¼");
}

// --- 3. LocalStorage å„²å­˜é‚è¼¯ ---
function saveToStorage(newRecord) {
    // å…ˆè®€å–èˆŠçš„è³‡æ–™ï¼Œæ²’æœ‰å°±çµ¦ç©ºé™£åˆ—
    let history = JSON.parse(localStorage.getItem("fall_history") || "[]");
    // æŠŠæ–°çš„å¡é€²å»
    history.unshift(newRecord); // åŠ åœ¨æœ€å‰é¢
    // å­˜å›ç€è¦½å™¨
    localStorage.setItem("fall_history", JSON.stringify(history));
}

function renderHistory() {
    const list = document.getElementById("historyList");
    let history = JSON.parse(localStorage.getItem("fall_history") || "[]");
    
    if (history.length === 0) {
        list.innerHTML = "å°šç„¡ç´€éŒ„";
        return;
    }

    list.innerHTML = history.map(item => `
        <div class="history-item">
            <span><b>${item.time}</b> (åŠ›é“éå¼·)</span>
            <a href="${item.url}" target="_blank" class="map-btn">æ‰“é–‹å®šä½</a>
        </div>
    `).join("");
}

// --- 4. åŸºç¤æ„Ÿæ¸¬å™¨åŠŸèƒ½ ---
function initSensors() {
    // è«‹æ±‚ä½ç½®
    navigator.geolocation.watchPosition(pos => {
        deviceState.lat = pos.coords.latitude;
        deviceState.lon = pos.coords.longitude;
        updateUI();
    }, null, { enableHighAccuracy: true });

    // è«‹æ±‚å‹•æ…‹æ„Ÿæ¸¬
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(permissionState => {
            if (permissionState === 'granted') window.addEventListener("devicemotion", onMotion);
        });
    } else {
        window.addEventListener("devicemotion", onMotion);
    }
    document.getElementById("status").textContent = "ç›£æ§ä¸­ï¼šç³»çµ±æ­£å¸¸é‹ä½œ";
}

function onMotion(e) {
    const acc = e.accelerationIncludingGravity;
    deviceState.x = acc.x || 0;
    deviceState.y = acc.y || 0;
    deviceState.z = acc.z || 0;
    updateUI();
    detectFall(deviceState);
}

function updateUI() {
    document.getElementById("stateDisplay").textContent = JSON.stringify(deviceState, null, 2);
}

function resetAlert() {
    isAlerted = false;
    document.getElementById("fallAlert").style.display = "none";
    document.body.style.backgroundColor = "#f0f2f5";
}

function clearHistory() {
    localStorage.removeItem("fall_history");
    renderHistory();
}

// åˆå§‹è¼‰å…¥æ­·å²ç´€éŒ„
window.onload = renderHistory;
</script>
</body>
</html>
